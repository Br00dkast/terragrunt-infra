name: Terragrunt CI Validation & Plan

on:
  pull_request:
    branches: [main, master]

jobs:
  validate_and_plan:
    # IMPORTANT: Use your self-hosted runner label here (e.g., 'lab-runner').
    runs-on: self-hosted
    
    # Set the execution context to the 'proxmox' directory.
    defaults:
      run:
        working-directory: proxmox 

    # --- üîê Environment Variable Injection (Mandatory for root.hcl) ---
    env:
      # All variables referenced by get_env() in root.hcl must be defined here.
      # They pull their values from your GitHub repository secrets.
      PROXMOX_API_URL: ${{ secrets.PROXMOX_API_URL }}
      PROXMOX_TOKEN_ID: ${{ secrets.PROXMOX_TOKEN_ID }}
      PROXMOX_SECRET: ${{ secrets.PROXMOX_SECRET }}
      PROXMOX_API_TOKEN: ${{ secrets.PROXMOX_API_TOKEN }}
      PROXMOX_SSH_PRIVATE_KEY: ${{ secrets.PROXMOX_SSH_PRIVATE_KEY }}
      
      NETBOX_SERVER_URL: ${{ secrets.NETBOX_SERVER_URL }}
      NETBOX_API_TOKEN: ${{ secrets.NETBOX_API_TOKEN }}
      
      MINIO_ENDPOINT: ${{ secrets.MINIO_ENDPOINT }}
      MINIO_BUCKET_NAME: ${{ secrets.MINIO_BUCKET_NAME }}
      MINIO_ACCESS_KEY: ${{ secrets.MINIO_ACCESS_KEY }}
      MINIO_SECRET_KEY: ${{ secrets.MINIO_SECRET_KEY }}
      
      SHARED_USERNAME: ${{ secrets.SHARED_USERNAME }}
      SHARED_PASSWORD: ${{ secrets.SHARED_PASSWORD }}
      SHARED_SSH_PUBLIC_KEY: ${{ secrets.SHARED_SSH_PUBLIC_KEY }}
      ADGUARD_ADMIN_PASSWORD: ${{ secrets.ADGUARD_ADMIN_PASSWORD }}

    steps:
      - name: Checkout Code (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # üîë 1. Setup SSH Agent to Clone Private Modules
      - name: Setup SSH for Private Modules
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_MODULES }}

      # üõ†Ô∏è 2. Setup OpenTofu/Terragrunt Tools
      - name: Setup OpenTofu/Terragrunt Tools
        # This will install Tofu/Terragrunt based on your local tool version file
        uses: gruntwork-io/terragrunt-action@v3
        
      # üßπ 3. Pre-Validation Check
      - name: Terragrunt HCL Format Check
        run: terragrunt hcl fmt --check --diff

      # --- üß™ 4. LIVE VALIDATION & PLAN ---
      - name: Terragrunt Full Validation & Plan
        run: |
          echo "Starting full multi-module validation using LAN access..."
          
          # INITIALIZE: Downloads modules/providers and connects to MinIO via LAN.
          # We no longer need --backend=false because the connection works on the local runner.
          terragrunt run-all init --upgrade
          
          # VALIDATE: Checks HCL syntax and configuration logic.
          terragrunt validate --all
          
          # PLAN: Creates a live plan using the initialized state.
          terragrunt run-all plan --no-color -lock=false
